<!--<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.13.1/datatables.min.css"/>-->
<!--<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.13.1/datatables.min.js"></script>-->
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-1">

      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">

      <div class="row">
        <div class="col-12">

          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <button class="btn btn-outline-danger mr-2 statBtn" title="Mới Tạo">
                  <i class="fas fa-box-open"></i>
                </button>

                <button class="btn btn-outline-warning mr-2 statBtn" title="Sẵn Sàng Giao">
                  <i class="fas fa-box"></i>
                </button>

                <button class="btn btn-outline-info mr-2 statBtn" title="Đã giao thành công" >
                  <i class="fas fa-dolly-flatbed"></i>
                </button>

                <button class="btn btn-outline-success mr-2 statBtn" title="Đơn Đã Hoàn Tất">
                  <i class="fas fa-check"></i>
                </button>
              </div>

              <div class="card-tools ">
                <div class="input-group input-group-sm" style="width: 150px;">
                  <input type="text" id="prodSearch" name="table_search" class="form-control " placeholder="Search">

                  <div class="input-group-append">
                    <button class="btn btn-outline-success float-right" id="addProduct" data-toggle="modal" data-target="#modal-md"><i class="fas fa-plus"></i></button>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body table-responsive p-0" style="height: 400px;">
              <table id="prodTable"  class="table table-head-fixed table-striped text-nowrap">

                <thead>
                <tr>
                  <th>Ngày tạo / Cập Nhật Lần Cuối</th>
                  <th>Tổng Tiền</th>
                  <th>Trạng Thái</th>
                  <th>Của Khách</th>
                  <th>Tại</th>
                  <th style="width: 20px;">Thao Tác</th>
                </tr>
                </thead>

                <tbody>
                <% @orders.each do |order|  %>
                  <tr>
                    <td><%= l(order.created_at,format: :custom) %> -
                      <%= l(order.updated_at,format: :custom) %>
                    </td>
                    <td><%= order.total %></td>
                    <td><%= order.status %></td>
                    <td><%= order.customer.name %></td>
                    <td><%= order.address.ward %>, <%= order.address.district %>, <%= order.address.province_city %></td>
                    <td><button class="btn btn-outline-success float-right btnUp" id="order-<%= order.id %>" data-toggle="modal" data-target="#modal-xl"><i class="fas fa-circle-info"></i></button></td>
                  </tr>
                <% end %>
                </tbody>


              </table>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
  </section>

</div>
<div class="modal fade" id="modal-xl">

  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Chi Tiết Đơn Hàng </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="orderDetail">

        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <h4>
                <small class="float-right" id="orderCre">Ngày Tạo: </small>
              </h4>
            </div>

          </div>
          <div class="row invoice-info">
            <div class="col-sm-4 invoice-col">
              Thông Tin Khách
              <address>
                <span id="cusName"></span><br>
                <span id="cusAddr"></span><br>
                <span id="cusPhone"></span><br>
                <span id="cusPayment"></span>
              </address>
            </div>

            <div class="col-sm-4 invoice-col">
              Người giới thiệu
              <address>
                <span id="refName"></span><br>
                <span id="refPhone"></span><br>
                <span id="refBank"></span><br>
              </address>
            </div>

            <div class="col-sm-4 invoice-col">
              <b>Thông Tin Khác</b><br>
              <br>
              <b>Cập Nhật Lần Cuối: </b> <span id="orderUpd"></span><br>

              <b>Cập Nhật Lần Cuối: </b> <span id="orderUpd"></span><br>
              <b>Ngày Hoàn Tất: </b> <span id="orderComp"></span>
            </div>

          </div>

          <div class="row mt-2">
            <div class="col col-md-7 table-responsive">
              <table class="table table-striped" id="lineItems">
                <thead>
                <tr>
                  <th>Tên</th>
                  <th>Số Lượng</th>
                  <th>Giá</th>
                  <th>Tổng Giá SP</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>

            <div class="col col-md-5">

              <div class="table-responsive">
                <table class="table" id="orderPrice">
                  <tbody><tr>
                    <th style="width:50%">Tổng phụ :</th>
                    <td id="orderSub"></td>
                  </tr>
                  <tr>
                    <th id="orderDis">Giảm (10%):</th>
                    <td id="orderDisMoney"></td>
                  </tr>
                  <tr>
                    <th>Phí Ship:</th>
                    <td id="orderShip"></td>
                  </tr>
                  <tr>
                    <th>Total:</th>
                    <td id="orderTotal"></td>
                  </tr>
                  </tbody></table>
              </div>
            </div>
          </div>


          <div class="row mt-2 mb-2">
            <div class="col-3">
              <div class="form-group">
                <label>Select</label>
                <select class="form-control orderStat" >
                  <option id="1">Mới Tạo</option>
                  <option id="2">Sẵn Sàng Giao</option>
                  <option id="3">Giao Thành Công</option>
                  <option id="4">Hoàn Tất Đơn</option>
                  <option id="5">Huỷ</option>
                </select>
              </div>
            </div>
            <div class="col-9">

            </div>
          </div>

        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
          <button type="button" class="btn btn-primary" id="updateOrder">Cập Nhật</button>
        </div>
      </form>

    </div>
    <!-- /.modal-content -->

  </div>
  <!-- /.modal-dialog -->
</div>

<div class="modal fade" id="modal-md2">

  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Cập Nhật Sản Phẩm </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="productUForm">

        <div class="modal-body">
          <div class="form-group">
            <label for="pname">Tên Sản Phẩm</label>
            <input type="email" class="form-control" id="pname" name="pname" placeholder="Nhập Tên">
          </div>

          <div class="form-group">
            <label for="pprice">Giá Sản Pẩm</label>
            <input type="email" class="form-control" id="pprice" name="pprice" placeholder="Giá">
          </div>

          <div class="form-group">
            <label for="exampleInputEmail1">Dung Tích</label>
            <input type="email" class="form-control" id="pvol" name="pvol" placeholder="lít, ml...">
          </div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-danger delProd" ><i class="fas fa-delete-left"></i></button>
          <input type="hidden" name="id" id="prodID">
          <button type="button" class="btn btn-primary uProd" ><i class="fas fa-floppy-disk"></i></button>
        </div>
      </form>

    </div>
    <!-- /.modal-content -->

  </div>
  <!-- /.modal-dialog -->
</div>

</script>
<script type="text/javascript" charset="utf-8">
    window.onload = orderSyle();

    function orderSyle() {

        $('.nitem2').addClass('menu-open');
        $('#side_order_menu').addClass('active');
        $('#side_order_menu').css('background-color', '#F7A4A4')
        $('.right').removeClass('fa-angle-left').addClass('fa-angle-down');

        $('#side-order2').addClass('active');
        $('#side-order2').css('background-color', '#FFFBC1');
        $('#side-order2').css('color', '#000');
    }

    function debounce(fn, delay) {
        var timer = null;
        return function () {
            var context = this, args = arguments;
            clearTimeout(timer);
            timer = setTimeout(function () {
                fn.apply(context, args);
            }, delay);
        };
    }


    $('.orderStat').bind('change',function () {
        var statSel = $(this).find(":selected");
        var orderID = $(this).attr('id');

        var actionUrl = '<%= change_order_stat_path %>';
        $.ajax({
            type: "PUT",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: actionUrl,
            data: {
                id: orderID,
                order_status: statSel.html()
            },
            success: function(data) {
                toastr.success('Đổi Thành Công','',{
                    timeOut: 3000,
                    progressBar: true,
                    progressAnimation: 'increasing'
                });
                $('#orderUpd').val(data.order.updated_at);
            }
        });
    });
    $('#prodSearch').keyup(debounce(function (event){
        var kw = $('#prodSearch').val();
        if(kw == '' && kw.length == 0){
            findProductByKW(kw,0);
        }else {
            findProductByKW(kw,1);

        }

    },3000));

    $('#prodTable').on('click','.btnUp',function (){
        var id =  $(this).attr('id').split('-')[1];
        findProduct(parseInt(id))
    });


    function findProductByKW(kw,choice) {
        var actionUrl = '<%= find_prod_path %>';

        $.ajax({
            type: "GET",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: actionUrl,
            data: {
                kw: kw,
                choice: choice
            }, // serializes the form's elements.
            success: function(data) {


                var hold = ''
                for(let i = 0;i < data.prod.length; i++  ){

                    hold += '<tr><td>'+data.prod[i].name+'</td>';
                    hold += '<td>'+data.prod[i].price+'</td>';
                    hold += '<td>'+data.prod[i].volume+'</td>';
                    hold += '<td> <button class="btn btn-outline-success float-right btnUp" id="prod-'+data.prod[i].id+'" data-toggle="modal" data-target="#modal-md2"><i class="fas fa-circle-info"></i></button></td></tr>';
                }
                $('#prodTable tbody').html(hold);

            }
        });
    }

    //Do items là trả về array chứa array chứa mảng, nen mới xài func extract
    function extract( array, newarray ){
        if( !newarray ) newarray = [] ;
        if( array ) for( var i = 0 ; i < array.length ; ++i )
        {
            if( array[i].constructor.name === "Array" ) extract( array[i], newarray ) ;
            else newarray.push( array[i] ) ;
        }
        return newarray ;
    }

    function findProduct(id) {
        var actionUrl = '<%= find_order_path %>';

        $.ajax({
            type: "GET",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: actionUrl,
            data: {
                orderID: id,
            },
            success: function(data) {
                //Items
                var hold = ''
                var subtotal = 0;
                var items = extract(data.itemx);
                for(let i = 0;i < items.length; i++  ){
                    hold += '<tr><td>'+items[i].name+'</td>';
                    hold += '<td>'+items[i].quantity+'</td>';
                    hold += '<td>'+items[i].price+'</td>';
                    hold += '<td>'+parseFloat(items[i].quantity * items[i].price).toFixed(3) +'</td>';
                    subtotal = subtotal +  (items[i].quantity * items[i].price);
                }
                $('#lineItems tbody').html(hold);

                $('.orderStat').attr('id',data.order.id);
                $('#orderSub').html(subtotal);
                $('#orderDis').html('Giảm ('+data.order.discount+'%):')
                $('#orderDisMoney').html(parseFloat((data.order.total * data.order.discount) / 100).toFixed(3))
                $('#orderTotal').html(data.order.total);
                $('#orderShip').html(data.order.shipping_cost);
                $('#orderCre').html('Ngày tạo: '+data.order.created_at);
                $('#orderUpd').html(data.order.updated_at);
                $('#orderComp').html(data.order.completed_at ? data.order.completed_at : 'Chưa Hoàn Tất' );

                //Customer
                $('#cusName').html('<b>Tên: </b>'+ data.cus.name);
                $('#cusAddr').html('<b>Địa Chỉ: </b>'+ data.address.street+', '+data.address.ward+ ', '+data.address.district+ ', '+data.address.province_city);
                $('#cusPhone').html('<b>Điện Thoại: </b>'+ data.cus.phone);
                $('#cusPayment').html('<b>Thanh Toán Bằng: </b>'+ data.order.payment_method);
                //Refer
                if(data.ref){
                    $('#refName').html('<b>Tên: </b>'+data.ref.name);
                    $('#refPhone').html('<b>Điện Thoại: </b>'+data.ref.phone);
                    $('#refBank').html('<b>Thông Tin CK: </b>'+data.ref.banking_informations);
                }else{
                    $('#refName').html('<b>Không Có Người Giới Thiệu</b>');
                }

            }
        });
    }


    $("#createProd").click(function(e) {
        e.preventDefault();
        var actionUrl = '<%= add_prod_path %>';
        var form = $('form#productForm');

        $.ajax({
            type: "POST",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: actionUrl,
            data: form.serialize(), // serializes the form's elements.
            success: function(data) {
                toastr.success(data.prod.name,data.message,{
                    timeOut: 3000,
                    progressBar: true,
                    progressAnimation: 'increasing'
                });

                var hold = ''
                hold += '<tr><td>'+data.prod.name+'</td>';
                hold += '<td>'+data.prod.price+'</td>';
                hold += '<td>'+data.prod.volume+'</td>';
                hold += '<td> <button class="btn btn-outline-success float-right btnUp" id="prod-'+data.prod[i].id+'" data-toggle="modal" data-target="#modal-md2"><i class="fas fa-circle-info"></i></button></td></tr>';
                $('#prodTable tbody').append(hold);

                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
                $("#modal-md").removeAttr("role").removeAttr("aria-modal").removeClass('show').css('display','none');
            }
        });
    });

    $(".delProd").click(function(e) {
        e.preventDefault();
        var actionUrl = '<%= delete_prod_path %>';
        var id = $('#prodID').val();
        $.ajax({
            type: "DELETE",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: actionUrl,
            data: {
                id:id
            }, // serializes the form's elements.
            success: function(data) {
                toastr.success(data.message,'',{
                    timeOut: 3000,
                    progressBar: true,
                    progressAnimation: 'increasing'
                });

                findProductByKW('',0);
            }
        });
    });

    $(".uProd").click(function(e) {
        e.preventDefault();
        var actionUrl = '<%= update_prod_path %>';
        var form = $('form#productUForm');

        $.ajax({
            type: "PUT",
            beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
            url: actionUrl,
            data: form.serialize(), // serializes the form's elements.
            success: function(data) {
                toastr.success(data.message,'',{
                    timeOut: 3000,
                    progressBar: true,
                    progressAnimation: 'increasing'
                });

                findProductByKW('',0);
            }
        });
    });



</script>


